#!/bin/sh

#Clean files
rm sugar.vx sugar.ConEnh sugar.filter sugar.th sugar.thArea sugar.com sugar.sobelAngle sugar.sobel sugar.hough sugar.ihough sugar.lbyn sugar.inte sugar.ithick 
rm sugar.noint sugar.nointT sugar.genRow sugar.freqLines sugar.OneSeg sugar.rows temp temp2 1 2 
rm sugar.customHough sugar.LinIntCOM sugar.COM sugar.annotGap sugar.annotGapThick sugar.annotRealGap 
rm sugar.HoughIntR sugar.houghRows sugar.Rthick sugar.filteredGaps sugar.Gap sugar.thAreaGapThick sugar.distance sugar.thAreaRow sugar.vdR 
rm sugar.annotA1 sugar.annotR sugar.AreaClosing sugar.rowlabel sugar.houghCOM sugar.houghFilt sugar.borderGap sugar.fhough sugar.GapThick sugar.thArea
##

#Compile code 
vcc LinearContrastEnhancement.c -o ContEnhancement
vcc RegionMetaDataBytes.c -o AreaTh
vcc COMPlot.c -o COMPlot
vcc FilterLines.c -o FilterLines
vcc LineMetaData.c -o LineMeta
vcc simple_t.c -o simple_t
vcc DrawRows.c -o DrawRows
vcc ThickRows.c -o ThickRows
vcc FilterLinesHough.c -o FilterLinesHough
vcc IdentCropRows.c -o IdentCropRows
vcc LineInterCOM.c -o LineInterCOM
vcc LineInterCOM_plotHough.c -o LineInterCOM_plotH
vcc CustomHInv.c -o CustomHInv
##

vformat if=$1 -gif of=sugar.vx -g  #GIF to VX

ContEnhancement if=sugar.vx of=sugar.ConEnh #Contrast enhacement / histogram normalization

simple_t if=sugar.ConEnh of=sugar.th t=$2 #Simple thresholding

AreaTh if=sugar.th of=sugar.thArea t=10  #Generate area thresholding 

vsobel if=sugar.thArea -d of=sugar.sobelAngle && vsobel if=sugar.thArea of=sugar.sobel #sobel edge with direction angle

vhoughl if=sugar.sobelAngle de=13 of=sugar.hough #Hough transform

HighRangeT if=sugar.hough r=22 of=sugar.houghFilt #High range threshold in Hough Space

COMPlot if=sugar.houghFilt of=sugar.houghCOM #Narrow regions in Hough tranform to single dots.  

FilterLinesHough if=sugar.houghCOM of=sugar.fhough #Filter lines in Hough Space by the 2 most frequent slopes

vhoughl -i if=sugar.fhough of=sugar.ihough #Hough Transform Inverse

vcmix if=sugar.vx ig=sugar.ihough of=sugar.annotA1 #Image Annotation with the result of the Hough Transform. 

##### find the image intersection and eliminate them. Lines can be splitted in segmented of lines. 
simple_t if=sugar.ihough t=10 of=sugar.lbyn  ##binarize image 

simple_t if=sugar.ihough t=100 of=sugar.inte #Identify the line intersection

vmorph if=sugar.inte s=15,15 -d t=s of=sugar.ithick #  make intersections thicker.

vop if=sugar.lbyn ig=sugar.ithick -sub of=sugar.noint ## intersections eliminated

simple_t if=sugar.noint t=1 of=sugar.nointT #bynary image without intersections
####

LineMeta if=sugar.nointT of=temp of2=sugar.freqLines #Find the most frequently lines (in XY Space) by slope and plot them

##Filter segment of lines, keep it just one at the end.
FilterLines if=sugar.freqLines of=temp
FilterLines if=temp of=temp2
FilterLines if=temp2 of=temp
FilterLines if=temp of=temp2
FilterLines if=temp2 of=sugar.OneSeg
##

COMPlot if=sugar.thArea of=sugar.COM #Center of Mass of original thresholded image
LineInterCOM_plotH if=sugar.OneSeg ig=sugar.COM of=sugar.LinIntCOM of2=sugar.customHough ## of:Intersept a line of average slope with all COM. of2: Mapping the lines in Custom Hough Space by ro and teta.

vmorph if=sugar.customHough s=3,3 -d t=s of=sugar.HoughIntR #Group the dots  that are within 3,3 pixels from each other in Custom Hough Space.
     
COMPlot if=sugar.HoughIntR of=sugar.houghRows #Narrow the regions to a single dot in Custom Hough Space

CustomHInv if=sugar.houghRows of=sugar.rows #Custom Hough Inverse transform. The output contain the lines representing the rows.

ThickRows if=sugar.rows of=sugar.Rthick #Create Rows from lines. 

IdentCropRows if=sugar.thArea ig=sugar.Rthick of=sugar.rowlabel of2=sugar.vdR #of=Create a structure of crops identified by row and number within a row. of2=visualize structure created

AreaTh if=sugar.rowlabel of=sugar.thAreaRow t=$3 #Area Region threshold to eliminate regions less than T pixels of area. It is useful to not count gaps generated by small regions.  

COMPlotGapV3 if=sugar.thAreaRow of=sugar.distance #Find the distance between two consecutive COM of crops.

vmorph if=sugar.thAreaRow of=sugar.thAreaGapThick -d t=s s=4 #Create a mask of the image with crops to segment the Gaps between crops. 

DIntersection if=sugar.distance if2=sugar.thAreaGapThick of=sugar.Gap #Segment the Gaps between two consecutive crop boundaries. 

AreaTh if=sugar.Gap of=sugar.filteredGaps t=$4 #Filter the gaps less than T pixels. It is useful to set the limit distance between crops that show need for replantation.

vmorph if=sugar.filteredGaps of=sugar.GapThick -d t=s s=5,20 #Show the gaps as Regions to be Replanted

vrcross if=sugar.GapThick | simple_t t=1 of=sugar.borderGap #Show the Regions to be Replanted as boundaries. Useful to annotate the image. 

vcmix if=sugar.thArea ig=sugar.borderGap of=sugar.annotGapThick #Annotate the Regions to be replanted in the thresholded image.

vcmix if=sugar.thArea ig=sugar.filteredGaps of=sugar.annotGap

vcmix if=sugar.vx ig=sugar.borderGap of=sugar.annotRealGap #Annotate the Regions to be replanted in the original image. 
#vcmix if=sugar.annotaRealGap ig=$5 of=11.vx
vxto gif if=sugar.annotRealGap of=$7 #Output of the script in GIF format

vformat if=$1 -gif -g of=$5
vbview if=$6 of=sugar.manualAnn n=1 -a
vxto gif if=sugar.manualAnn of=temp
vformat if=temp.gif -gif -g of=temp2
simple_t if=temp2 of=temp3 t=130

vcmix if=sugar.annotRealGap ig=temp3 of=test -r


